<title>Data Track Architecture</title>

<h2>Table of Contents</h2>
<table>
<tr><td><a href="#overview">Track overview</a>
<tr><td><a href="#new_tracks">Adding new tracks</a>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#old_semantics">Adding a Track with Currently Defined Semantics</a>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#new_semantics">Adding a Track with New Semantics</a>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#cell_tracks">Adding a Cell Result Track</a>
<tr><td><a href="#persistability">Persistability</a>

</table>

<a name="overview"></a>
<h2>Data Track Overview</h2>

Each data track contains a time-stamped collection of data containers. Different APIs are used to write data to tracks and to read data from tracks. Application engine rcWriter API in <code>rc_engine.h</code> is used to create tracks and write data to them. Application model rcTrack API in <code>rc_model.h</code> is used by data consumers (GUI, persistence layer etc.) to access data.

<p>
<table border=1 cellspacing=2 cellpadding=2>
<tr><td><i>Track Type</i><td><i>Data Type</i><td><i>Persistability</i><td><i>Writer Class</i><td><i>Reader Class</i><td><i>Display Widget</i>
<tr><td>Video<td><code>rcWindow</code><td>Only by capture process in .rfymov file<td><code>rcVideoWriter</code><td><code>rcVideoTrack</code><td><code>rcImageCanvasGL</code>
<tr><td>Graphics<td><code>rcVisualGraphicsCollection</code><td>XML in .rfyeml file, soon as binary in .rfygra file<td><code>rcGraphicsWriter</code><td><code>rcGraphicsTrack</code><td><code>rcImageCanvasGL</code>
<tr><td>Scalar<td><code>double</code><td>XML in .rfyeml file<td><code>rcScalarWriter</code><td><code>rcScalarTrack</code><td><code>rcTimeline</code>
<tr><td>Position<td><code>rcFPair</code><td>XML in .rfyeml file<td><code>rcPositionWriter</code><td><code>rcPositionTrack</code><td><code>rcPositionWidget</code>
</table>

<p>
Data track code common to Visible and Visibatch is declared in <code>applications/common/engine/include/rc_engineimplbase.h</code>.
Code specific to an application is declared in  <code>applications/*/src/code/rc_engineimpl.h</code>. Eventually most track handling code should migrate to the base class.

<a name="new_tracks"></a>
<h2>Adding New Tracks</h2>
Using utility class <code>rcWriterManager (products/applications/common/engine/include/rc_writermanager.h)</code> is the easiest way to create new tracks. As a convenience there is a way to attach data semantics to a particular track so that tracks can be found based on their semantic type (which is tied to XML tag) instead of using the track name. See <code>enum rcWriterSemantics</code> for a list of predefined track semantics. Each track needs to be created in a context of a <code>rcWriterGroup</code>. There are default groups for video data, graphics data and global measurements. Data tracks for individuals cells have each their own cell data group.
<p>
If you are adding a track that contains data with a new semantic meaning, please <a href="#new_semantics">add a new enumeration</a> in <code>enum rcWriterSemantics</code>. It's easy and it will avoid confusion.

<a name="old_semantics"></a>
<h3>Adding a Track with Currently Defined Semantics</h3>
As an example a scalar energy track is added.
<ol>
<li>Add a new <code>rcEngineFocusData</code> writer data member in <code>applications/common/engine/include/rc_engineimplbase.h</code>. For example: <br><pre>        rcScalarWriter* mEnergyWriter2;</pre>
<li>Add track construction call in <code>rcEngineFocusData</code> constructor in <code>applications/common/engine/src/rc_engineimplfocus.cpp</code>. Add it to the appropriate <code>switch ( analysismode )</code> branch. For example:  
<pre>         mEnergyWriter2 = mWriterManager->createScalarWriter( mWriterGroup,
                                                              eWriterACI,
                                                              sizeLimit,
                                                              0.0,   // expected min
                                                              1.0 ); // expected max
         mGlobalWriters.push_back( mEnergyWriter->down_cast() );
</pre>
<li>In <code>applications/visible/src/code/rc_engineimpl.cpp</code> add a call to write values to the track in method <code>rcEngineImpl::analyzeFocusArea()</code> in the appropriate <code>_analysisMode</code> branch. For example: <br>
<pre>
         mEnergyWriter2->writeScalarValue( curTimeStamp, focus->focusRect(), newValue );
</pre>
</ol>

<a name="new_semantics"></a>
<h3>Adding a Track with New Semantics</h3>
As an example a new track with position values is added.
<ol>
<li>Add a new <code>rcWriterSemantics</code> enumeration in <code>products/applications/common/engine/include/rc_writermanager.h</code>. Add it to the end of the enumeration list but before <code>eWriterUnknown</code> which must be the last type. For example:<br>
<pre>
         eWriterCenterOfUniverse
</pre>

<li>Add a new entry in <code>sWriterInfoArray</code> in <code>products/applications/common/engine/src/code/rc_writermanager.cpp</code>. It must have a unique XML tag which can never be changed. Display name, description and format string do not have to be unique and they can be changed later. For example:<br>
<pre>
         rcWriterInfo( eWriterCenterOfUniverse, ePositionWriter, "center-of-universe", "Center of Universe", "True Center of Known Universe (x,y)", "(%-4.0f, %-4.0f)" )
</pre>

<li>Follow the <a href="#old_semantics">track addition<a> instructions above.
</ol>

<a name="cell_tracks"></a>
<h3>Adding a New Cell Result Track</h3>
<ol>
<li>If necessary, <a href="#new_semantics">add a new enumeration</a>.
<li>Add a new enumeration for <code>rcCellResultType</code> in <code>applications/common/engine/include/rc_engineimplbase.h</code>.
<li>Add a new result field with an appropriate access and mutator in <code>rcCellResult</code> class. 
<li>Add a new <code>rcWriter</code> member with appropriate semantics in <code>rcCellWriterGroup</code> in <code>applications/common/engine/src/rc_engineimplcells.cpp</code>.
<li>Add code to take the value from <code>rcCellResultType</code> and write it to the corresponding track in <code>rcCellWriterGroup::writeValues()</code>.
</ol>

<a name="persistability"></a>
<h2>Persistability</h2>
All tracks except <code>rcVideoTrack</code> are persistable by default and their contents will be exported by "Save" and "Export" commands. However,  <code>rcGraphicsTrack</code> values will not be exported to CSV files and locomotive body speed+direction value export to CSV files has also been temporarily disabled. 

<p>To disable track persistence, use <code>rcWriter::setExportable(false)</code> method.

<p><font size=-1><i>Author: <a href="mailto:sami@reifycorp.com">Sami Kukkonen</a><i></font>
<hr>
<center>
<font size=-1>Copyright &copy; 2003 Reify Corporation. All rights reserved.</font><p>
</center>

